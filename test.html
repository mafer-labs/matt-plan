<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD98vj78VL5Vm9xvqvSz3zGBWj34D8vuMo",
            authDomain: "josefsen-skeie-app.firebaseapp.com",
            projectId: "josefsen-skeie-app",
            storageBucket: "josefsen-skeie-app.firebasestorage.app",
            messagingSenderId: "198203528510",
            appId: "1:198203528510:web:c3f5d61a6fa6e47180486f",
            measurementId: "G-1EN2J9CBNL",
            databaseURL: "https://josefsen-skeie-app-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();


        // --- ICONS (SVG Replacements) ---
        const Icon = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        const HomeIcon = ({className}) => <Icon className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>;
        const CheckSquareIcon = ({className}) => <Icon className={className}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></Icon>;
        const CalendarIcon = ({className}) => <Icon className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const BriefcaseIcon = ({className}) => <Icon className={className}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>;
        const Trash2Icon = ({className}) => <Icon className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const PlusIcon = ({className}) => <Icon className={className}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;


        // --- MAIN APP COMPONENT ---
        const FamilyApp = () => {
            const [currentView, setCurrentView] = useState('home');

            // Data States
            const [shoppingItems, setShoppingItems] = useState([]);
            const [events, setEvents] = useState([]);
            const [schedules, setSchedules] = useState([]);
            const [dinnerPlan, setDinnerPlan] = useState('');

            // Input States
            const [newItem, setNewItem] = useState('');
            const [newPrice, setNewPrice] = useState('');
            const [newStore, setNewStore] = useState('Rema100');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [newEventText, setNewEventText] = useState('');
            const [newEventTime, setNewEventTime] = useState('');
            
            // Schedule Inputs
            const [schPerson, setSchPerson] = useState('Mokka');
            const [schType, setSchType] = useState('Work');
            const [schDate, setSchDate] = useState('');
            const [schTime, setSchTime] = useState('');

            // Store List
            const stores = [
                "Rema100", "KIWI", "Spar", "Mega", "Europris", 
                "Holbart", "Meny", "ODA", "OBS"
            ];

            // --- 2. FIREBASE SYNC (useEffect) ---
            useEffect(() => {
                // Listen for Shopping List
                const shopRef = db.ref('shopping');
                shopRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                        setShoppingItems(list);
                    } else {
                        setShoppingItems([]);
                    }
                });

                // Listen for Events
                const eventsRef = db.ref('events');
                eventsRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                        setEvents(list);
                    } else {
                        setEvents([]);
                    }
                });

                // Listen for Schedules
                const schedRef = db.ref('schedules');
                schedRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                        setSchedules(list);
                    } else {
                        setSchedules([]);
                    }
                });

                // Listen for Dinner
                const dinnerRef = db.ref('dinner');
                dinnerRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) setDinnerPlan(data);
                });

            }, []); // Run once on load


            // --- ACTIONS (Write to Firebase) ---

            // Shopping
            const addToShoppingList = () => {
                if (!newItem) return;
                const newRef = db.ref('shopping').push();
                newRef.set({ 
                    text: newItem, 
                    price: newPrice || '0', 
                    store: newStore, 
                    checked: false 
                });
                setNewItem('');
                setNewPrice('');
                setNewStore('Rema100');
            };

            const toggleItem = (id, currentStatus) => {
                db.ref(`shopping/${id}`).update({ checked: !currentStatus });
            };

            const deleteItem = (id) => {
                db.ref(`shopping/${id}`).remove();
            };

            const calculateTotal = () => {
                return shoppingItems.reduce((acc, curr) => acc + parseFloat(curr.price), 0);
            };

            // Calendar
            const addEvent = () => {
                if (!newEventText) return;
                db.ref('events').push({
                    date: selectedDate.toDateString(), 
                    text: newEventText,
                    time: newEventTime 
                });
                setNewEventText('');
                setNewEventTime('');
            };

            // Work Schedule
            const addSchedule = () => {
                if (!schDate || !schTime) return;
                const finalType = schPerson === 'Mokka' ? 'Work' : schType;
                
                db.ref('schedules').push({
                    person: schPerson,
                    type: finalType,
                    date: schDate,
                    time: schTime
                });
                // Keep date, clear time
                setSchTime(''); 
            };

            // Dinner
            const updateDinner = (text) => {
                setDinnerPlan(text); // update local immediately for smooth typing
                db.ref('dinner').set(text); // save to cloud
            };


            // --- HELPER: RENDER CALENDAR ---
            const daysInMonth = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).getDay();

            const renderCalendar = () => {
                const days = [];
                const totalDays = daysInMonth(selectedDate);
                const startDay = firstDayOfMonth(selectedDate);

                for (let i = 0; i < startDay; i++) {
                    days.push(<div key={`empty-${i}`} className="h-24 bg-gray-50 border"></div>);
                }

                for (let d = 1; d <= totalDays; d++) {
                    const currentDateString = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), d).toDateString();
                    const dayEvents = events.filter(e => e.date === currentDateString);

                    days.push(
                        <div 
                            key={d} 
                            onClick={() => setSelectedDate(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), d))}
                            className={`h-24 border p-1 overflow-auto cursor-pointer hover:bg-blue-50 ${selectedDate.getDate() === d ? 'bg-blue-100 ring-2 ring-blue-500' : 'bg-white'}`}
                        >
                            <div className="font-bold text-sm mb-1">{d}</div>
                            {dayEvents.map((ev) => (
                                <div key={ev.id} className="text-xs bg-blue-200 rounded p-1 mb-1 truncate">
                                    {ev.time && <span className="font-bold mr-1">{ev.time}</span>}
                                    {ev.text}
                                </div>
                            ))}
                        </div>
                    );
                }
                return days;
            };

            // --- VIEW ---
            return (
                <div className="min-h-screen bg-gray-100 pb-20 font-sans">
                
                    {/* HEADER */}
                    <header className="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-10">
                        <div className="flex justify-center items-center">
                            <h1 className="text-2xl font-bold">Family Dashboard</h1>
                            {/* Online Indicator */}
                            <div className="w-2 h-2 bg-green-400 rounded-full ml-2 animate-pulse" title="Connected to Firebase"></div>
                        </div>
                    </header>

                    {/* MAIN CONTENT */}
                    <main className="max-w-md mx-auto p-4">

                        {/* === HOME VIEW === */}
                        {currentView === 'home' && (
                            <div className="space-y-6">
                                
                                {/* Middag Section */}
                                <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-orange-400">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                        <span className="text-2xl mr-2">üçΩÔ∏è</span> Middag
                                    </h2>
                                    <textarea
                                        className="w-full p-3 border rounded-lg bg-orange-50 focus:ring-2 focus:ring-orange-300 outline-none"
                                        rows="3"
                                        placeholder="What's for dinner today?"
                                        value={dinnerPlan}
                                        onChange={(e) => updateDinner(e.target.value)}
                                    />
                                </div>

                                {/* Work & School Schedule Section */}
                                <div className="bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-400">
                                    <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                        <BriefcaseIcon className="mr-2 text-indigo-600" /> Work & School
                                    </h2>
                                    
                                    <div className="bg-indigo-50 p-4 rounded-lg mb-4">
                                        <div className="grid grid-cols-2 gap-3 mb-3">
                                            <div>
                                                <label className="text-xs font-bold text-gray-600 block mb-1">Who</label>
                                                <select className="w-full p-2 border rounded" value={schPerson} onChange={(e) => setSchPerson(e.target.value)}>
                                                    <option value="Mokka">Mokka</option>
                                                    <option value="Jokkis">Jokkis</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs font-bold text-gray-600 block mb-1">What</label>
                                                {schPerson === 'Mokka' ? (
                                                    <input type="text" value="Work" disabled className="w-full p-2 border rounded bg-gray-200 text-gray-500" />
                                                ) : (
                                                    <select className="w-full p-2 border rounded" value={schType} onChange={(e) => setSchType(e.target.value)}>
                                                        <option value="Work">Work</option>
                                                        <option value="School">School</option>
                                                    </select>
                                                )}
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-3 mb-3">
                                            <input type="date" value={schDate} onChange={e => setSchDate(e.target.value)} className="p-2 border rounded text-sm"/>
                                            <input type="time" value={schTime} onChange={e => setSchTime(e.target.value)} className="p-2 border rounded text-sm"/>
                                        </div>

                                        <button onClick={addSchedule} className="w-full bg-indigo-600 text-white py-2 rounded font-bold hover:bg-indigo-700 transition">
                                            Add Schedule
                                        </button>
                                    </div>

                                    <div className="space-y-2">
                                        {schedules.map(sch => (
                                            <div key={sch.id} className="flex justify-between items-center bg-gray-50 p-3 rounded border-l-4 border-indigo-300">
                                                <div>
                                                    <span className={`font-bold ${sch.person === 'Mokka' ? 'text-pink-600' : 'text-blue-600'}`}>
                                                        {sch.person}
                                                    </span>
                                                    <span className="text-gray-500 text-sm ml-2">@ {sch.type}</span>
                                                </div>
                                                <div className="text-right text-xs text-gray-600">
                                                    <div>{sch.date}</div>
                                                    <div className="font-mono font-bold">{sch.time}</div>
                                                </div>
                                            </div>
                                        ))}
                                        {schedules.length === 0 && <p className="text-gray-400 text-center text-sm italic">No schedules added.</p>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* === SHOPPING VIEW === */}
                        {currentView === 'shopping' && (
                            <div className="bg-white p-6 rounded-xl shadow-md min-h-[500px]">
                                <h2 className="text-2xl font-bold mb-6 flex items-center justify-between">
                                    <span>üõí Shopping List</span>
                                    <span className="text-lg bg-green-100 text-green-800 px-3 py-1 rounded-full">
                                        {calculateTotal()} kr
                                    </span>
                                </h2>

                                <div className="flex flex-col gap-2 mb-6 bg-gray-50 p-4 rounded-lg">
                                    <input
                                        type="text"
                                        className="flex-grow p-3 border rounded focus:outline-blue-500"
                                        placeholder="Add item..."
                                        value={newItem}
                                        onChange={(e) => setNewItem(e.target.value)}
                                    />
                                    <div className="flex gap-2">
                                        <input 
                                            type="number" 
                                            placeholder="Pris" 
                                            className="w-24 p-2 border rounded"
                                            value={newPrice}
                                            onChange={(e) => setNewPrice(e.target.value)}
                                        />
                                        <select 
                                            className="flex-grow p-2 border rounded"
                                            value={newStore}
                                            onChange={(e) => setNewStore(e.target.value)}
                                        >
                                            {stores.map(s => <option key={s} value={s}>{s}</option>)}
                                        </select>
                                    </div>
                                    <button
                                        onClick={addToShoppingList}
                                        className="bg-blue-600 text-white p-3 rounded font-bold hover:bg-blue-700 flex justify-center items-center gap-2"
                                    >
                                        <PlusIcon /> Add Item
                                    </button>
                                </div>

                                <ul className="space-y-3">
                                    {shoppingItems.map((item) => (
                                        <li key={item.id} className={`flex items-center justify-between p-3 rounded border ${item.checked ? 'bg-gray-100 border-gray-200' : 'bg-white border-gray-300'}`}>
                                            <div className="flex items-center gap-3 overflow-hidden">
                                                <button onClick={() => toggleItem(item.id, item.checked)}>
                                                    {item.checked 
                                                        ? <CheckSquareIcon className="text-green-500" /> 
                                                        : <div className="w-6 h-6 border-2 border-gray-400 rounded"></div>
                                                    }
                                                </button>
                                                <div className="flex flex-col">
                                                    <span className={`font-medium ${item.checked ? 'line-through text-gray-400' : 'text-gray-800'}`}>
                                                        {item.text}
                                                    </span>
                                                    <span className="text-xs text-gray-500 uppercase font-bold tracking-wider">
                                                        {item.store}
                                                    </span>
                                                </div>
                                            </div>
                                            
                                            <div className="flex items-center gap-3">
                                                <span className="font-bold text-gray-700 whitespace-nowrap">{item.price} kr</span>
                                                <button onClick={() => deleteItem(item.id)} className="text-red-400 hover:text-red-600">
                                                    <Trash2Icon size={18} />
                                                </button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {/* === CALENDAR VIEW === */}
                        {currentView === 'calendar' && (
                            <div className="bg-white p-4 rounded-xl shadow-md">
                                <h2 className="text-xl font-bold mb-4 flex items-center">
                                    <CalendarIcon className="mr-2 text-blue-600" /> Calendar
                                </h2>
                                
                                <div className="grid grid-cols-7 gap-1 mb-6 text-center">
                                    {['S','M','T','W','T','F','S'].map(d => <div key={d} className="font-bold text-gray-400 text-xs">{d}</div>)}
                                    {renderCalendar()}
                                </div>

                                <div className="border-t pt-4">
                                    <h3 className="font-bold text-gray-700 mb-2">
                                        {selectedDate.toDateString()}
                                    </h3>
                                    <div className="flex flex-col gap-2">
                                        <input
                                            type="text"
                                            placeholder="Add event details..."
                                            className="w-full p-2 border rounded"
                                            value={newEventText}
                                            onChange={(e) => setNewEventText(e.target.value)}
                                        />
                                        <div className="flex gap-2">
                                            <input 
                                                type="time" 
                                                className="p-2 border rounded"
                                                value={newEventTime}
                                                onChange={(e) => setNewEventTime(e.target.value)}
                                            />
                                            <button 
                                                onClick={addEvent}
                                                className="bg-green-600 text-white px-4 py-2 rounded font-bold hover:bg-green-700 flex-grow"
                                            >
                                                Add Event
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>

                    {/* BOTTOM NAVIGATION */}
                    <nav className="fixed bottom-0 w-full bg-white border-t border-gray-200 flex justify-around py-3 pb-5 z-50">
                        <button 
                            onClick={() => setCurrentView('home')}
                            className={`flex flex-col items-center ${currentView === 'home' ? 'text-blue-600' : 'text-gray-400'}`}
                        >
                            <HomeIcon />
                            <span className="text-xs mt-1">Home</span>
                        </button>
                        <button 
                            onClick={() => setCurrentView('shopping')}
                            className={`flex flex-col items-center ${currentView === 'shopping' ? 'text-blue-600' : 'text-gray-400'}`}
                        >
                            <div className="relative">
                                <CheckSquareIcon />
                                {shoppingItems.filter(i => !i.checked).length > 0 && (
                                    <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center">
                                        {shoppingItems.filter(i => !i.checked).length}
                                    </span>
                                )}
                            </div>
                            <span className="text-xs mt-1">Shop</span>
                        </button>
                        <button 
                            onClick={() => setCurrentView('calendar')}
                            className={`flex flex-col items-center ${currentView === 'calendar' ? 'text-blue-600' : 'text-gray-400'}`}
                        >
                            <CalendarIcon />
                            <span className="text-xs mt-1">Plan</span>
                        </button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FamilyApp />);
    </script>
</body>
</html>
