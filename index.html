<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middag - Josefsen-Skeie</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        window.firebaseModules = { initializeApp, getDatabase, ref, set, onValue };
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0fdfa; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Clean Date Input */
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0; position: absolute; left: 0; top: 0; width: 100%; height: 100%; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    // ==========================================
    // ✅ FINAL CONFIGURATION
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyD98vj78VL5Vm9xvqvSz3zGBWj34D8vuMo",
        authDomain: "josefsen-skeie-app.firebaseapp.com",
        projectId: "josefsen-skeie-app",
        storageBucket: "josefsen-skeie-app.firebasestorage.app",
        messagingSenderId: "198203528510",
        appId: "1:198203528510:web:c3f5d61a6fa6e47180486f",
        measurementId: "G-1EN2J9CBNL",
        // Added from your previous message:
        databaseURL: "https://josefsen-skeie-app-default-rtdb.europe-west1.firebasedatabase.app"
    };
    // ==========================================

    const { useState, useEffect, useMemo, useRef } = React;

    // --- CONFIG ---
    const STORES = ["Rema 1000 Nordre Åsen", "Kiwi Bjerke", "Joker Disen", "Meny Grefsen", "Europris", "Gigaboks", "Annet / General"];
    const STORE_COLORS = {
        "Rema 1000 Nordre Åsen": "bg-blue-100 text-blue-900 border-blue-200",
        "Kiwi Bjerke": "bg-green-100 text-green-900 border-green-200",
        "Joker Disen": "bg-yellow-100 text-yellow-900 border-yellow-200",
        "Meny Grefsen": "bg-red-100 text-red-900 border-red-200",
        "Annet / General": "bg-gray-100 text-gray-800 border-gray-200"
    };

    const DICTIONARY = {
        en: {
            appTitle: "Middag Josefsen-Skeie",
            tabs: ["Calendar", "Groceries"],
            shoppingList: "Shopping List",
            addItem: "Add item (e.g. Milk)",
            add: "Add",
            move: "Move to date",
            today: "Today",
            clear: "Clear",
            saved: "Synced",
            saving: "Syncing...",
            error: "Connection Error"
        },
        no: {
            appTitle: "Middag Josefsen-Skeie",
            tabs: ["Kalender", "Handleliste"],
            shoppingList: "Handleliste",
            addItem: "Legg til vare (f.eks Melk)",
            add: "Legg til",
            move: "Flytt til dato",
            today: "I dag",
            clear: "Tøm",
            saved: "Lagret",
            saving: "Lagrer...",
            error: "Koblingsfeil"
        }
    };

    // --- HELPERS ---
    const getMonday = (d) => {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    };
    const formatDateKey = (date) => date.toISOString().split('T')[0];
    const addDays = (date, days) => {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    };

    const App = () => {
        const [db, setDb] = useState(null);

        // State
        const [lang, setLang] = useState('en'); 
        const [view, setView] = useState('calendar');
        const [currentWeekStart, setCurrentWeekStart] = useState(getMonday(new Date()));
        
        // Data
        const [mealData, setMealData] = useState({});
        const [groceries, setGroceries] = useState([]);
        const [syncStatus, setSyncStatus] = useState('saved');

        // Inputs
        const [groceryInput, setGroceryInput] = useState("");
        const [selectedStore, setSelectedStore] = useState(STORES[0]);
        
        // Debounce Ref
        const timeoutRef = useRef(null);

        const t = DICTIONARY[lang];

        // --- FIREBASE INIT ---
        useEffect(() => {
            try {
                const { initializeApp, getDatabase, ref, onValue } = window.firebaseModules;
                const app = initializeApp(firebaseConfig);
                const database = getDatabase(app);
                setDb(database);

                // SUBSCRIBE TO DATA
                const dataRef = ref(database, 'family_data');
                onValue(dataRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        if (data.meals) setMealData(data.meals);
                        if (data.groceries) setGroceries(data.groceries);
                    }
                }, (error) => {
                    console.error("Read Error:", error);
                    setSyncStatus('error');
                    alert("Database Error: Ensure you selected 'Start in Test Mode' in Firebase Console -> Database -> Rules.");
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                setSyncStatus('error');
            }
        }, []);

        // --- SYNC LOGIC ---
        const saveData = (newMeals, newGroceries) => {
            if (!db) return;
            setSyncStatus('saving');
            
            // Clear existing timeout to debounce
            if (timeoutRef.current) clearTimeout(timeoutRef.current);

            timeoutRef.current = setTimeout(() => {
                const { ref, set } = window.firebaseModules;
                set(ref(db, 'family_data'), {
                    meals: newMeals,
                    groceries: newGroceries
                }).then(() => {
                    setSyncStatus('saved');
                }).catch(err => {
                    console.error("Write Error:", err);
                    setSyncStatus('error');
                });
            }, 500); 
        };

        // --- ACTIONS ---
        const updateMeal = (dateKey, val) => {
            const newMeals = { ...mealData, [dateKey]: { name: val } };
            setMealData(newMeals); // Optimistic update
            saveData(newMeals, groceries);
        };

        const changeMealDate = (oldDateKey, newDateString) => {
            if (!newDateString || oldDateKey === newDateString) return;
            
            const newMeals = { ...mealData };
            const currentName = newMeals[oldDateKey]?.name || "";
            
            newMeals[newDateString] = { name: currentName }; // Move text
            newMeals[oldDateKey] = { name: "" }; // Clear old
            
            setMealData(newMeals);
            saveData(newMeals, groceries);
        };

        const addGrocery = () => {
            if (groceryInput.trim() === "") return;
            const newGroceries = [...groceries, { 
                id: Date.now(), 
                text: groceryInput, 
                store: selectedStore, 
                checked: false 
            }];
            setGroceries(newGroceries);
            setGroceryInput("");
            saveData(mealData, newGroceries);
        };

        const toggleGrocery = (id) => {
            const newGroceries = groceries.map(g => g.id === id ? { ...g, checked: !g.checked } : g);
            setGroceries(newGroceries);
            saveData(mealData, newGroceries);
        };

        const deleteGrocery = (id) => {
            const newGroceries = groceries.filter(g => g.id !== id);
            setGroceries(newGroceries);
            saveData(mealData, newGroceries);
        };

        // --- COMPUTED ---
        const groceriesByStore = useMemo(() => {
            const groups = {};
            STORES.forEach(s => groups[s] = []);
            groceries.forEach(item => {
                if (groups[item.store]) groups[item.store].push(item);
                else {
                    if(!groups["Annet / General"]) groups["Annet / General"] = [];
                    groups["Annet / General"].push(item);
                }
            });
            return groups;
        }, [groceries]);

        // --- RENDER: APP ---
        return (
            <div className="min-h-screen max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden flex flex-col font-sans">
                
                {/* HEADER */}
                <header className="bg-teal-700 text-white p-4 shadow-md sticky top-0 z-50">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex flex-col">
                            <h1 className="text-xl font-bold tracking-wide">{t.appTitle}</h1>
                            <div className="flex items-center gap-2 text-xs text-teal-200">
                                {syncStatus === 'saving' || syncStatus === 'error' ? 
                                    <i className={`ph ${syncStatus === 'error' ? 'ph-warning text-red-300' : 'ph-spinner animate-spin'}`}></i> 
                                    : <i className="ph ph-cloud-check"></i>
                                }
                                <span>{syncStatus === 'error' ? t.error : (syncStatus === 'saving' ? t.saving : t.saved)}</span>
                            </div>
                        </div>
                        <button onClick={() => setLang(lang === 'en' ? 'no' : 'en')} className="bg-teal-900/40 hover:bg-teal-800 px-3 py-1 rounded text-xs font-bold transition">
                            {lang === 'en' ? 'NO' : 'EN'}
                        </button>
                    </div>
                    <div className="flex gap-4 text-sm font-medium">
                        <button onClick={() => setView('calendar')} className={`flex-1 pb-2 border-b-4 transition ${view === 'calendar' ? 'border-teal-200 text-white' : 'border-transparent text-teal-300'}`}>
                            {t.tabs[0]}
                        </button>
                        <button onClick={() => setView('groceries')} className={`flex-1 pb-2 border-b-4 transition ${view === 'groceries' ? 'border-teal-200 text-white' : 'border-transparent text-teal-300'}`}>
                            {t.tabs[1]}
                        </button>
                    </div>
                </header>

                <main className="flex-1 overflow-y-auto p-3 pb-20">

                    {/* VIEW: CALENDAR */}
                    {view === 'calendar' && (
                        <div className="space-y-4">
                            <div className="bg-white rounded-lg p-3 shadow-sm flex justify-between items-center">
                                <button onClick={() => setCurrentWeekStart(addDays(currentWeekStart, -7))} className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"><i className="ph ph-caret-left"></i></button>
                                <div className="text-center">
                                    <div className="text-sm font-bold text-gray-800">
                                        {currentWeekStart.toLocaleDateString(lang === 'en'?'en-GB':'no-NO', {day:'numeric', month:'short'})} - 
                                        {addDays(currentWeekStart, 6).toLocaleDateString(lang === 'en'?'en-GB':'no-NO', {day:'numeric', month:'short'})}
                                    </div>
                                </div>
                                <button onClick={() => setCurrentWeekStart(addDays(currentWeekStart, 7))} className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"><i className="ph ph-caret-right"></i></button>
                            </div>

                            <div className="space-y-3">
                                {Array(7).fill(0).map((_, i) => {
                                    const date = addDays(currentWeekStart, i);
                                    const dateKey = formatDateKey(date);
                                    const data = mealData[dateKey] || { name: "" };
                                    const isToday = formatDateKey(new Date()) === dateKey;

                                    return (
                                        <div key={dateKey} className={`relative p-3 rounded-xl border-l-4 shadow-sm transition ${isToday ? 'bg-white border-teal-500 ring-2 ring-teal-50 z-10' : 'bg-white border-gray-200'}`}>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className={`text-xs font-bold uppercase ${isToday ? 'text-teal-600' : 'text-gray-400'}`}>
                                                    {date.toLocaleDateString(lang==='en'?'en-GB':'no-NO', {weekday:'long', day:'numeric', month:'numeric'})}
                                                </span>
                                                <div className="relative group">
                                                    <button className="text-gray-300 hover:text-teal-600" title={t.move}>
                                                        <i className="ph ph-calendar-plus text-lg"></i>
                                                    </button>
                                                    <input 
                                                        type="date" 
                                                        className="absolute top-0 right-0 w-8 h-8 opacity-0 cursor-pointer"
                                                        onChange={(e) => changeMealDate(dateKey, e.target.value)}
                                                    />
                                                </div>
                                            </div>

                                            <input 
                                                type="text" 
                                                value={data.name}
                                                onChange={(e) => updateMeal(dateKey, e.target.value)}
                                                placeholder="..."
                                                className="w-full bg-transparent font-medium text-lg text-gray-800 outline-none placeholder-gray-300 border-b border-transparent focus:border-teal-300 transition"
                                            />
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* VIEW: GROCERIES */}
                    {view === 'groceries' && (
                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded-xl shadow-md sticky top-0 z-20 border border-teal-50">
                                <div className="flex flex-col gap-3">
                                    <select 
                                        value={selectedStore} 
                                        onChange={(e) => setSelectedStore(e.target.value)}
                                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-semibold text-gray-700 outline-none focus:border-teal-500"
                                    >
                                        {STORES.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            value={groceryInput}
                                            onChange={(e) => setGroceryInput(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && addGrocery()}
                                            placeholder={t.addItem}
                                            className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-teal-500"
                                        />
                                        <button onClick={addGrocery} className="bg-teal-600 text-white px-4 rounded-lg shadow hover:bg-teal-700 transition">
                                            <i className="ph ph-plus font-bold"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {STORES.map(store => {
                                const items = groceriesByStore[store] || [];
                                if (items.length === 0) return null;
                                
                                return (
                                    <div key={store} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden slide-in">
                                        <div className={`px-4 py-2 text-sm font-bold flex items-center justify-between ${STORE_COLORS[store] || STORE_COLORS["Annet / General"]}`}>
                                            <span>{store}</span>
                                            <span className="bg-white/40 px-2 rounded-full text-xs">{items.length}</span>
                                        </div>
                                        <div className="divide-y divide-gray-50">
                                            {items.map(item => (
                                                <div key={item.id} className="flex items-center gap-3 p-3 hover:bg-gray-50 group">
                                                    <button onClick={() => toggleGrocery(item.id)} className={`w-5 h-5 rounded border flex items-center justify-center transition ${item.checked ? 'bg-gray-400 border-gray-400' : 'bg-white border-gray-300'}`}>
                                                        {item.checked && <i className="ph ph-check text-white text-xs"></i>}
                                                    </button>
                                                    <span className={`flex-1 text-sm ${item.checked ? 'text-gray-300 line-through' : 'text-gray-700'}`}>{item.text}</span>
                                                    <button onClick={() => deleteGrocery(item.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                                        <i className="ph ph-trash"></i>
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>
