<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middag - Disengrenda</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0fdfa; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Remove default date input styling for cleaner look */
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0; position: absolute; left: 0; top: 0; width: 100%; height: 100%; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

    const { useState, useEffect, useMemo } = React;

    // --- CONFIG: LOCAL STORES ---
    const STORES = [
        "Rema 1000 Nordre Åsen", 
        "Kiwi Bjerke", 
        "Joker Disen", 
        "Meny Grefsen", 
        "Europris", 
        "Gigaboks",
        "Annet / General"
    ];

    const STORE_COLORS = {
        "Rema 1000 Nordre Åsen": "bg-blue-100 text-blue-900 border-blue-200", // Rema Blue
        "Kiwi Bjerke": "bg-green-100 text-green-900 border-green-200", // Kiwi Green
        "Joker Disen": "bg-yellow-100 text-yellow-900 border-yellow-200", // Joker Yellow
        "Meny Grefsen": "bg-red-100 text-red-900 border-red-200", // Meny Red
        "Annet / General": "bg-gray-100 text-gray-800 border-gray-200"
    };

    const DICTIONARY = {
        en: {
            appTitle: "Middag Disengrenda",
            tabs: ["Calendar", "Groceries"],
            totalBudget: "Est. Cost",
            shoppingList: "Shopping List",
            addItem: "Add item (e.g. Milk)",
            add: "Add",
            move: "Move to date",
            today: "Today",
            clear: "Clear",
            selectStore: "Select Store"
        },
        no: {
            appTitle: "Middag Disengrenda",
            tabs: ["Kalender", "Handleliste"],
            totalBudget: "Est. Pris",
            shoppingList: "Handleliste",
            addItem: "Legg til vare (f.eks Melk)",
            add: "Legg til",
            move: "Flytt til dato",
            today: "I dag",
            clear: "Tøm",
            selectStore: "Velg Butikk"
        }
    };

    // --- HELPERS ---
    const getMonday = (d) => {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    };
    const formatDateKey = (date) => date.toISOString().split('T')[0];
    const addDays = (date, days) => {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    };

    const App = () => {
        // --- STATE ---
        const [lang, setLang] = useState('en'); 
        const [view, setView] = useState('calendar');
        
        // Data
        const [currentWeekStart, setCurrentWeekStart] = useState(getMonday(new Date()));
        const [mealData, setMealData] = useState({});
        const [groceries, setGroceries] = useState([]);
        
        // Inputs
        const [groceryInput, setGroceryInput] = useState("");
        const [selectedStore, setSelectedStore] = useState(STORES[0]);

        const t = DICTIONARY[lang];

        // --- PERSISTENCE ---
        useEffect(() => {
            const savedMeals = JSON.parse(localStorage.getItem('middag_meals_v4'));
            const savedGroceries = JSON.parse(localStorage.getItem('middag_groceries_v4'));
            if (savedMeals) setMealData(savedMeals);
            if (savedGroceries) setGroceries(savedGroceries);
        }, []);

        useEffect(() => {
            localStorage.setItem('middag_meals_v4', JSON.stringify(mealData));
            localStorage.setItem('middag_groceries_v4', JSON.stringify(groceries));
        }, [mealData, groceries]);

        // --- LOGIC ---
        const updateMeal = (dateKey, field, value) => {
            setMealData(prev => ({
                ...prev,
                [dateKey]: { ...prev[dateKey], [field]: value }
            }));
        };

        const changeMealDate = (oldDateKey, newDateString) => {
            if (!newDateString || oldDateKey === newDateString) return;
            
            setMealData(prev => {
                const newData = { ...prev };
                const currentMeal = newData[oldDateKey] || { name: "", price: "" };
                
                // Copy to new date
                newData[newDateString] = { 
                    name: currentMeal.name, 
                    price: currentMeal.price 
                };
                
                // Clear old date
                newData[oldDateKey] = { name: "", price: "" };
                return newData;
            });
            alert(`Moved to ${newDateString}`);
        };

        const addGrocery = () => {
            if (groceryInput.trim() === "") return;
            setGroceries([...groceries, { 
                id: Date.now(), 
                text: groceryInput, 
                store: selectedStore, 
                checked: false 
            }]);
            setGroceryInput("");
        };

        const toggleGrocery = (id) => setGroceries(groceries.map(g => g.id === id ? { ...g, checked: !g.checked } : g));
        const deleteGrocery = (id) => setGroceries(groceries.filter(g => g.id !== id));

        const groceriesByStore = useMemo(() => {
            const groups = {};
            STORES.forEach(s => groups[s] = []);
            groceries.forEach(item => {
                if (groups[item.store]) groups[item.store].push(item);
                else {
                    if(!groups["Annet / General"]) groups["Annet / General"] = [];
                    groups["Annet / General"].push(item);
                }
            });
            return groups;
        }, [groceries]);

        const weeklyTotal = useMemo(() => {
            return Array(7).fill(0).map((_, i) => addDays(currentWeekStart, i)).reduce((acc, date) => {
                const key = formatDateKey(date);
                return acc + (parseInt(mealData[key]?.price) || 0);
            }, 0);
        }, [mealData, currentWeekStart]);

        // --- RENDER ---
        return (
            <div className="min-h-screen max-w-md mx-auto bg-gray-50 shadow-2xl overflow-hidden flex flex-col font-sans">
                
                {/* HEADER */}
                <header className="bg-teal-700 text-white p-4 shadow-md sticky top-0 z-50">
                    <div className="flex justify-between items-center mb-4">
                        <div className="flex flex-col">
                            <h1 className="text-xl font-bold tracking-wide">{t.appTitle}</h1>
                            <span className="text-xs text-teal-200 opacity-80">24G Family Planner</span>
                        </div>
                        <button onClick={() => setLang(lang === 'en' ? 'no' : 'en')} className="bg-teal-900/40 hover:bg-teal-800 px-3 py-1 rounded text-xs font-bold transition">
                            {lang === 'en' ? 'NO' : 'EN'}
                        </button>
                    </div>
                    <div className="flex gap-4 text-sm font-medium">
                        <button onClick={() => setView('calendar')} className={`flex-1 pb-2 border-b-4 transition ${view === 'calendar' ? 'border-teal-200 text-white' : 'border-transparent text-teal-300'}`}>
                            {t.tabs[0]}
                        </button>
                        <button onClick={() => setView('groceries')} className={`flex-1 pb-2 border-b-4 transition ${view === 'groceries' ? 'border-teal-200 text-white' : 'border-transparent text-teal-300'}`}>
                            {t.tabs[1]}
                        </button>
                    </div>
                </header>

                <main className="flex-1 overflow-y-auto p-3 pb-20">

                    {/* VIEW: CALENDAR */}
                    {view === 'calendar' && (
                        <div className="space-y-4">
                            {/* Week Nav */}
                            <div className="bg-white rounded-lg p-3 shadow-sm flex justify-between items-center">
                                <button onClick={() => setCurrentWeekStart(addDays(currentWeekStart, -7))} className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"><i className="ph ph-caret-left"></i></button>
                                <div className="text-center">
                                    <div className="text-sm font-bold text-gray-800">
                                        {currentWeekStart.toLocaleDateString(lang === 'en'?'en-GB':'no-NO', {day:'numeric', month:'short'})} - 
                                        {addDays(currentWeekStart, 6).toLocaleDateString(lang === 'en'?'en-GB':'no-NO', {day:'numeric', month:'short'})}
                                    </div>
                                    <div className="text-xs text-teal-600 font-bold mt-1">{t.totalBudget}: {weeklyTotal} kr</div>
                                </div>
                                <button onClick={() => setCurrentWeekStart(addDays(currentWeekStart, 7))} className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"><i className="ph ph-caret-right"></i></button>
                            </div>

                            {/* Days */}
                            <div className="space-y-3">
                                {Array(7).fill(0).map((_, i) => {
                                    const date = addDays(currentWeekStart, i);
                                    const dateKey = formatDateKey(date);
                                    const data = mealData[dateKey] || { name: "", price: "" };
                                    const isToday = formatDateKey(new Date()) === dateKey;

                                    return (
                                        <div key={dateKey} className={`relative p-3 rounded-xl border-l-4 shadow-sm transition ${isToday ? 'bg-white border-teal-500 ring-2 ring-teal-50 z-10' : 'bg-white border-gray-200'}`}>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className={`text-xs font-bold uppercase ${isToday ? 'text-teal-600' : 'text-gray-400'}`}>
                                                    {date.toLocaleDateString(lang==='en'?'en-GB':'no-NO', {weekday:'long', day:'numeric', month:'numeric'})}
                                                </span>
                                                
                                                {/* CHANGE DATE BUTTON */}
                                                <div className="relative group">
                                                    <button className="text-gray-300 hover:text-teal-600" title={t.move}>
                                                        <i className="ph ph-calendar-plus text-lg"></i>
                                                    </button>
                                                    <input 
                                                        type="date" 
                                                        className="absolute top-0 right-0 w-8 h-8 opacity-0 cursor-pointer"
                                                        onChange={(e) => changeMealDate(dateKey, e.target.value)}
                                                    />
                                                </div>
                                            </div>

                                            <div className="flex gap-2">
                                                <input 
                                                    type="text" 
                                                    value={data.name}
                                                    onChange={(e) => updateMeal(dateKey, 'name', e.target.value)}
                                                    placeholder="..."
                                                    className="flex-1 bg-transparent font-medium text-gray-800 outline-none placeholder-gray-300 border-b border-transparent focus:border-teal-300 transition"
                                                />
                                                <input 
                                                    type="number"
                                                    value={data.price}
                                                    onChange={(e) => updateMeal(dateKey, 'price', e.target.value)}
                                                    placeholder="kr"
                                                    className="w-16 text-right bg-gray-50 rounded px-2 text-sm text-gray-600 outline-none focus:ring-1 focus:ring-teal-300"
                                                />
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* VIEW: GROCERIES */}
                    {view === 'groceries' && (
                        <div className="space-y-6">
                            
                            {/* Input Box */}
                            <div className="bg-white p-4 rounded-xl shadow-md sticky top-0 z-20 border border-teal-50">
                                <div className="flex flex-col gap-3">
                                    <select 
                                        value={selectedStore} 
                                        onChange={(e) => setSelectedStore(e.target.value)}
                                        className="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm font-semibold text-gray-700 outline-none focus:border-teal-500"
                                    >
                                        {STORES.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            value={groceryInput}
                                            onChange={(e) => setGroceryInput(e.target.value)}
                                            onKeyDown={(e) => e.key === 'Enter' && addGrocery()}
                                            placeholder={t.addItem}
                                            className="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-teal-500"
                                        />
                                        <button onClick={addGrocery} className="bg-teal-600 text-white px-4 rounded-lg shadow hover:bg-teal-700 transition">
                                            <i className="ph ph-plus font-bold"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Lists by Store */}
                            {STORES.map(store => {
                                const items = groceriesByStore[store] || [];
                                if (items.length === 0) return null;
                                
                                return (
                                    <div key={store} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden slide-in">
                                        <div className={`px-4 py-2 text-sm font-bold flex items-center justify-between ${STORE_COLORS[store] || STORE_COLORS["Annet / General"]}`}>
                                            <span>{store}</span>
                                            <span className="bg-white/40 px-2 rounded-full text-xs">{items.length}</span>
                                        </div>
                                        <div className="divide-y divide-gray-50">
                                            {items.map(item => (
                                                <div key={item.id} className="flex items-center gap-3 p-3 hover:bg-gray-50 group">
                                                    <button onClick={() => toggleGrocery(item.id)} className={`w-5 h-5 rounded border flex items-center justify-center transition ${item.checked ? 'bg-gray-400 border-gray-400' : 'bg-white border-gray-300'}`}>
                                                        {item.checked && <i className="ph ph-check text-white text-xs"></i>}
                                                    </button>
                                                    <span className={`flex-1 text-sm ${item.checked ? 'text-gray-300 line-through' : 'text-gray-700'}`}>{item.text}</span>
                                                    <button onClick={() => deleteGrocery(item.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                                        <i className="ph ph-trash"></i>
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })}

                            {groceries.length === 0 && (
                                <div className="text-center text-gray-400 mt-12">
                                    <i className="ph ph-shopping-cart text-4xl mb-2 opacity-20"></i>
                                    <p>Ready to plan!</p>
                                </div>
                            )}
                        </div>
                    )}

                </main>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>
</body>
</html>
